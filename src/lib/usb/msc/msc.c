#include "types.h"

#include "usb.h"
#include "usb_cfg.h"
#include "msc_defs.h"
#include "msc.h"

/* MSC Disk Image Definitions */
#define MSC_ImageSize          (0x00001000)

/* Mass Storage gMemory Layout */
#define MSC_MemorySize         (8192)
#define MSC_BlockSize          (512)
#define MSC_BlockCount         (MSC_MemorySize / MSC_BlockSize)

/* Mass Storage gMemory Image*/
const U8 FlashDiskImage[MSC_ImageSize] =
{
0xEB,0x3C,0x90,0x4D,0x53,0x44,0x4F,0x53,0x35,0x2E,0x30,0x00,0x02,0x01,0x01,0x00,
0x01,0x10,0x00,0x40,0x00,0xF8,0x02,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x29,0x74,0x19,0x02,0x27,0x53,0x54,0x4D,0x33,0x32,
0x78,0x5F,0x55,0x53,0x42,0x20,0x46,0x41,0x54,0x31,0x32,0x20,0x20,0x20,0x33,0xC9,
0x8E,0xD1,0xBC,0xF0,0x7B,0x8E,0xD9,0xB8,0x00,0x20,0x8E,0xC0,0xFC,0xBD,0x00,0x7C,
0x38,0x4E,0x24,0x7D,0x24,0x8B,0xC1,0x99,0xE8,0x3C,0x01,0x72,0x1C,0x83,0xEB,0x3A,
0x66,0xA1,0x1C,0x7C,0x26,0x66,0x3B,0x07,0x26,0x8A,0x57,0xFC,0x75,0x06,0x80,0xCA,
0x02,0x88,0x56,0x02,0x80,0xC3,0x10,0x73,0xEB,0x33,0xC9,0x8A,0x46,0x10,0x98,0xF7,
0x66,0x16,0x03,0x46,0x1C,0x13,0x56,0x1E,0x03,0x46,0x0E,0x13,0xD1,0x8B,0x76,0x11,
0x60,0x89,0x46,0xFC,0x89,0x56,0xFE,0xB8,0x20,0x00,0xF7,0xE6,0x8B,0x5E,0x0B,0x03,
0xC3,0x48,0xF7,0xF3,0x01,0x46,0xFC,0x11,0x4E,0xFE,0x61,0xBF,0x00,0x00,0xE8,0xE6,
0x00,0x72,0x39,0x26,0x38,0x2D,0x74,0x17,0x60,0xB1,0x0B,0xBE,0xA1,0x7D,0xF3,0xA6,
0x61,0x74,0x32,0x4E,0x74,0x09,0x83,0xC7,0x20,0x3B,0xFB,0x72,0xE6,0xEB,0xDC,0xA0,
0xFB,0x7D,0xB4,0x7D,0x8B,0xF0,0xAC,0x98,0x40,0x74,0x0C,0x48,0x74,0x13,0xB4,0x0E,
0xBB,0x07,0x00,0xCD,0x10,0xEB,0xEF,0xA0,0xFD,0x7D,0xEB,0xE6,0xA0,0xFC,0x7D,0xEB,
0xE1,0xCD,0x16,0xCD,0x19,0x26,0x8B,0x55,0x1A,0x52,0xB0,0x01,0xBB,0x00,0x00,0xE8,
0x3B,0x00,0x72,0xE8,0x5B,0x8A,0x56,0x24,0xBE,0x0B,0x7C,0x8B,0xFC,0xC7,0x46,0xF0,
0x3D,0x7D,0xC7,0x46,0xF4,0x29,0x7D,0x8C,0xD9,0x89,0x4E,0xF2,0x89,0x4E,0xF6,0xC6,
0x06,0x96,0x7D,0xCB,0xEA,0x03,0x00,0x00,0x20,0x0F,0xB6,0xC8,0x66,0x8B,0x46,0xF8,
0x66,0x03,0x46,0x1C,0x66,0x8B,0xD0,0x66,0xC1,0xEA,0x10,0xEB,0x5E,0x0F,0xB6,0xC8,
0x4A,0x4A,0x8A,0x46,0x0D,0x32,0xE4,0xF7,0xE2,0x03,0x46,0xFC,0x13,0x56,0xFE,0xEB,
0x4A,0x52,0x50,0x06,0x53,0x6A,0x01,0x6A,0x10,0x91,0x8B,0x46,0x18,0x96,0x92,0x33,
0xD2,0xF7,0xF6,0x91,0xF7,0xF6,0x42,0x87,0xCA,0xF7,0x76,0x1A,0x8A,0xF2,0x8A,0xE8,
0xC0,0xCC,0x02,0x0A,0xCC,0xB8,0x01,0x02,0x80,0x7E,0x02,0x0E,0x75,0x04,0xB4,0x42,
0x8B,0xF4,0x8A,0x56,0x24,0xCD,0x13,0x61,0x61,0x72,0x0B,0x40,0x75,0x01,0x42,0x03,
0x5E,0x0B,0x49,0x75,0x06,0xF8,0xC3,0x41,0xBB,0x00,0x00,0x60,0x66,0x6A,0x00,0xEB,
0xB0,0x4E,0x54,0x4C,0x44,0x52,0x20,0x20,0x20,0x20,0x20,0x20,0x0D,0x0A,0x52,0x65,
0x6D,0x6F,0x76,0x65,0x20,0x64,0x69,0x73,0x6B,0x73,0x20,0x6F,0x72,0x20,0x6F,0x74,
0x68,0x65,0x72,0x20,0x6D,0x65,0x64,0x69,0x61,0x2E,0xFF,0x0D,0x0A,0x44,0x69,0x73,
0x6B,0x20,0x65,0x72,0x72,0x6F,0x72,0xFF,0x0D,0x0A,0x50,0x72,0x65,0x73,0x73,0x20,
0x61,0x6E,0x79,0x20,0x6B,0x65,0x79,0x20,0x74,0x6F,0x20,0x72,0x65,0x73,0x74,0x61,
0x72,0x74,0x0D,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xAC,0xCB,0xD8,0x55,0xAA,
0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x53,0x54,0x4D,0x33,0x32,0x78,0x5F,0x55,0x53,0x42,0x20,0x28,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xE5,0x45,0x41,0x44,0x4D,0x45,0x20,0x20,0x54,0x58,0x54,0x20,0x00,0x00,0x00,0x00,
0x21,0x00,0xBB,0x32,0x00,0x00,0xDC,0x83,0xBB,0x32,0x02,0x00,0x57,0x00,0x00,0x00,
0xE5,0x52,0x00,0x65,0x00,0x61,0x00,0x64,0x00,0x4D,0x00,0x0F,0x00,0x73,0x65,0x00,
0x2E,0x00,0x74,0x00,0x78,0x00,0x74,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,
0xE5,0x45,0x41,0x44,0x4D,0x45,0x20,0x20,0x54,0x58,0x54,0x20,0x00,0x87,0x99,0x71,
0x45,0x37,0x45,0x37,0x00,0x00,0x4F,0x68,0x45,0x37,0x02,0x00,0x5E,0x00,0x00,0x00,
0x41,0x52,0x00,0x65,0x00,0x61,0x00,0x64,0x00,0x4D,0x00,0x0F,0x00,0x73,0x65,0x00,
0x2E,0x00,0x74,0x00,0x78,0x00,0x74,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,
0x52,0x45,0x41,0x44,0x4D,0x45,0x20,0x20,0x54,0x58,0x54,0x20,0x00,0x87,0x99,0x71,
0x45,0x37,0x4C,0x37,0x00,0x00,0x32,0x4D,0x4C,0x37,0x02,0x00,0x5F,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x54,0x68,0x69,0x73,0x20,0x69,0x73,0x20,0x61,0x20,0x55,0x53,0x42,0x20,0x4D,0x65,
0x6D,0x6F,0x72,0x79,0x20,0x44,0x65,0x76,0x69,0x63,0x65,0x20,0x64,0x65,0x6D,0x6F,
0x6E,0x73,0x74,0x72,0x61,0x74,0x69,0x6F,0x6E,0x20,0x66,0x6F,0x72,0x0D,0x0A,0x74,
0x68,0x65,0x20,0x4B,0x65,0x69,0x6C,0x20,0x4D,0x43,0x42,0x53,0x54,0x4D,0x33,0x32,
0x20,0x42,0x6F,0x61,0x72,0x64,0x20,0x77,0x69,0x74,0x68,0x20,0x53,0x54,0x20,0x53,
0x54,0x4D,0x33,0x32,0x46,0x31,0x30,0x33,0x52,0x42,0x54,0x36,0x2E,0x0D,0x0A,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

/* Global Variables */
/* MSC RAM */
static U8      gMemory[MSC_MemorySize];
/* gMemory OK */
static U32     gMemOK;
/* R/W gRwOffset */
static U32     gRwOffset;
/* R/W gRwLength */
static U32     gRwLength;
/* Bulk Stage */
static U8      gBulkStage;
/* Bulk In/Out Buffer */
static U8      gBulkBuf[USB_MSC_PACKET_SIZE];
/* Bulk In/Out gRwLength */
static U8      gBulkRwLength;
/* Command Block Wrapper */
static MSC_CBW gCBW;
/* Command Status Wrapper */
static MSC_CSW gCSW;

//-----------------------------------------------------------------------------
/** @brief MSC Control Setup USB Request
 *  @param pSetup - Pointer to Setup Packet
 *  @param pData - Pointer to place for setting the pointer to requested data
 *  @param pSize - Pointer to place for setting the requested data size
 *  @return Stage that should be performed after calling this function
 *  @note On calling this function pData points to Control Endpoint internal
 *        buffer so requested data can be placed right there if it is not
 *        exceeds Control Endpoint Max Packet size
 */
USB_CTRL_STAGE MSC_CtrlSetupReq
(
  USB_SETUP_PACKET * pSetup,
  U8 **pData,
  U16 *pSize
)
{
  USB_CTRL_STAGE result = USB_CTRL_STAGE_ERROR;
  
  switch (pSetup->bRequest)
  {
    case MSC_REQUEST_RESET:
      /* MSC Mass Storage Reset Request */
      /* Turn Off R/W LED */
      //GPIOB->ODR &= ~(LED_RD | LED_WR);
      gBulkStage = MSC_BS_CBW;
      *pSize = 0;
      result = USB_CTRL_STAGE_STATUS;
      break;
    case MSC_REQUEST_GET_MAX_LUN:
      /* No LUN associated with this device */
      *pData[0] = 0;
      *pSize = 1;
      result = USB_CTRL_STAGE_DATA;
      break;
  }
  
  return result;
}

//-----------------------------------------------------------------------------
/** @brief MSC gMemory Read Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_MemoryRead(void)
{
  U32 n;

  if (gRwLength > USB_MSC_PACKET_SIZE)
  {
    n = USB_MSC_PACKET_SIZE;
  }
  else
  {
    n = gRwLength;
  }

  if ((gRwOffset + n) > MSC_MemorySize)
  {
    n = MSC_MemorySize - gRwOffset;
    gBulkStage = MSC_BS_DATA_IN_LAST_STALL;
  }

  USB_EpWrite(USB_MSC_EP_BULK_IN, &gMemory[gRwOffset], n);
  gRwOffset += n;
  gRwLength -= n;

  gCSW.dDataResidue -= n;

  if (gRwLength == 0)
  {
    gBulkStage = MSC_BS_DATA_IN_LAST;
  }

  if (gBulkStage != MSC_BS_DATA_IN)
  {
    /* Turn Off Read LED */
    //GPIOB->ODR &= ~LED_RD;
    gCSW.bStatus = CSW_CMD_PASSED;
  }
}

//-----------------------------------------------------------------------------
/** @brief MSC Set Command Status Wrapper Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_SetCSW(void)
{
  gCSW.dSignature = MSC_CSW_Signature;
  USB_EpWrite(USB_MSC_EP_BULK_IN, (U8 *)&gCSW, sizeof(gCSW));
  gBulkStage = MSC_BS_CSW;
}

//-----------------------------------------------------------------------------
/** @brief MSC Memory Write Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_MemoryWrite(void)
{
  U32 n;

  if ((gRwOffset + gBulkRwLength) > MSC_MemorySize)
  {
    gBulkRwLength = MSC_MemorySize - gRwOffset;
    gBulkStage = MSC_BS_CSW;
    USB_EpSetStall(USB_MSC_EP_BULK_OUT);
  }

  for (n = 0; n < gBulkRwLength; n++)
  {
    gMemory[gRwOffset + n] = gBulkBuf[n];
  }

  gRwOffset += gBulkRwLength;
  gRwLength -= gBulkRwLength;

  gCSW.dDataResidue -= gBulkRwLength;

  if ((gRwLength == 0) || (gBulkStage == MSC_BS_CSW))
  {
    /* Turn Off Write LED */
    //GPIOB->ODR &= ~LED_WR;
    gCSW.bStatus = CSW_CMD_PASSED;
    MSC_SetCSW();
  }
}

//-----------------------------------------------------------------------------
/** @brief MSC Memory Verify Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_MemoryVerify(void)
{
  U32 n;

  if ((gRwOffset + gBulkRwLength) > MSC_MemorySize)
  {
    gBulkRwLength = MSC_MemorySize - gRwOffset;
    gBulkStage = MSC_BS_CSW;
    USB_EpSetStall(USB_MSC_EP_BULK_OUT);
  }

  for (n = 0; n < gBulkRwLength; n++)
  {
    if (gMemory[gRwOffset + n] != gBulkBuf[n])
    {
      gMemOK = FALSE;
      break;
    }
  }

  gRwOffset += gBulkRwLength;
  gRwLength -= gBulkRwLength;

  gCSW.dDataResidue -= gBulkRwLength;

  if ((gRwLength == 0) || (gBulkStage == MSC_BS_CSW))
  {
    gCSW.bStatus = (gMemOK) ? CSW_CMD_PASSED : CSW_CMD_FAILED;
    MSC_SetCSW();
  }
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Read/Write Setup Callback
 *  @param None (global variables)
 *  @return TRUE - Success, FALSE - Error
 */
U32 MSC_RWSetup(void)
{
  U32 n;

  /* Logical Block Address of First Block */
  n = (gCBW.CB[2] << 24) |
      (gCBW.CB[3] << 16) |
      (gCBW.CB[4] <<  8) |
      (gCBW.CB[5] <<  0);

  gRwOffset = n * MSC_BlockSize;

  /* Number of Blocks to transfer */
  n = (gCBW.CB[7] <<  8) |
      (gCBW.CB[8] <<  0);

  gRwLength = n * MSC_BlockSize;

  if (gCBW.dDataLength != gRwLength)
  {
    USB_EpSetStall(USB_MSC_EP_BULK_IN);
    USB_EpSetStall(USB_MSC_EP_BULK_OUT);
    gCSW.bStatus = CSW_PHASE_ERROR;
    MSC_SetCSW();
    return (FALSE);
  }

  return (TRUE);
}

//-----------------------------------------------------------------------------
/** @brief Check Data IN Format
 *  @param None (global variables)
 *  @return TRUE - Success, FALSE - Error
 */
U32 DataInFormat(void)
{
  if (gCBW.dDataLength == 0)
  {
    gCSW.bStatus = CSW_PHASE_ERROR;
    MSC_SetCSW();
    return (FALSE);
  }
  if ((gCBW.bmFlags & 0x80) == 0)
  {
    USB_EpSetStall(USB_MSC_EP_BULK_OUT);
    gCSW.bStatus = CSW_PHASE_ERROR;
    MSC_SetCSW();
    return (FALSE);
  }
  return (TRUE);
}

//-----------------------------------------------------------------------------
/** @brief Perform Data IN Transfer
 *  @param None (global variables)
 *  @return None
 */
void DataInTransfer(void)
{
  if (gBulkRwLength > gCBW.dDataLength)
  {
    gBulkRwLength = gCBW.dDataLength;
  }

  USB_EpWrite(USB_MSC_EP_BULK_IN, gBulkBuf, gBulkRwLength);
  gBulkStage = MSC_BS_DATA_IN_LAST;

  gCSW.dDataResidue -= gBulkRwLength;
  gCSW.bStatus = CSW_CMD_PASSED;
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Test Unit Ready Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_TestUnitReady(void)
{
  if (gCBW.dDataLength != 0)
  {
    if ((gCBW.bmFlags & 0x80) != 0)
    {
      USB_EpSetStall(USB_MSC_EP_BULK_IN);
    }
    else
    {
      USB_EpSetStall(USB_MSC_EP_BULK_OUT);
    }
  }

  gCSW.bStatus = CSW_CMD_PASSED;
  MSC_SetCSW();
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Request Sense Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_RequestSense(void)
{
  if (!DataInFormat()) return;

  gBulkBuf[ 0] = 0x70;          /* Response Code */
  gBulkBuf[ 1] = 0x00;
  gBulkBuf[ 2] = 0x02;          /* Sense Key */
  gBulkBuf[ 3] = 0x00;
  gBulkBuf[ 4] = 0x00;
  gBulkBuf[ 5] = 0x00;
  gBulkBuf[ 6] = 0x00;
  gBulkBuf[ 7] = 0x0A;          /* Additional gRwLength */
  gBulkBuf[ 8] = 0x00;
  gBulkBuf[ 9] = 0x00;
  gBulkBuf[10] = 0x00;
  gBulkBuf[11] = 0x00;
  gBulkBuf[12] = 0x30;          /* ASC */
  gBulkBuf[13] = 0x01;          /* ASCQ */
  gBulkBuf[14] = 0x00;
  gBulkBuf[15] = 0x00;
  gBulkBuf[16] = 0x00;
  gBulkBuf[17] = 0x00;

  gBulkRwLength = 18;
  DataInTransfer();
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Inquiry Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_Inquiry(void)
{
  if (!DataInFormat()) return;

  gBulkBuf[ 0] = 0x00;          /* Direct Access Device */
  gBulkBuf[ 1] = 0x80;          /* RMB = 1: Removable Medium */
  gBulkBuf[ 2] = 0x00;          /* Version: No conformance claim to standard */
  gBulkBuf[ 3] = 0x01;

  gBulkBuf[ 4] = 36-4;          /* Additional gRwLength */
  gBulkBuf[ 5] = 0x80;          /* SCCS = 1: Storage Controller Component */
  gBulkBuf[ 6] = 0x00;
  gBulkBuf[ 7] = 0x00;

  gBulkBuf[ 8] = 'K';           /* Vendor Identification */
  gBulkBuf[ 9] = 'e';
  gBulkBuf[10] = 'i';
  gBulkBuf[11] = 'l';
  gBulkBuf[12] = ' ';
  gBulkBuf[13] = ' ';
  gBulkBuf[14] = ' ';
  gBulkBuf[15] = ' ';

  gBulkBuf[16] = 'M';           /* Product Identification */
  gBulkBuf[17] = 'C';
  gBulkBuf[18] = 'B';
  gBulkBuf[19] = 'S';
  gBulkBuf[20] = 'T';
  gBulkBuf[21] = 'M';
  gBulkBuf[22] = '3';
  gBulkBuf[23] = '2';
  gBulkBuf[24] = ' ';
  gBulkBuf[25] = 'D';
  gBulkBuf[26] = 'I';
  gBulkBuf[27] = 'S';
  gBulkBuf[28] = 'K';
  gBulkBuf[29] = ' ';
  gBulkBuf[30] = ' ';
  gBulkBuf[31] = ' ';

  gBulkBuf[32] = '1';           /* Product Revision Level */
  gBulkBuf[33] = '.';
  gBulkBuf[34] = '0';
  gBulkBuf[35] = ' ';

  gBulkRwLength = 36;
  DataInTransfer();
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Mode Sense (6-Byte) Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_ModeSense6(void)
{
  if (!DataInFormat()) return;

  gBulkBuf[ 0] = 0x03;
  gBulkBuf[ 1] = 0x00;
  gBulkBuf[ 2] = 0x00;
  gBulkBuf[ 3] = 0x00;

  gBulkRwLength = 4;
  DataInTransfer();
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Mode Sense (10-Byte) Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_ModeSense10(void)
{
  if (!DataInFormat()) return;

  gBulkBuf[ 0] = 0x00;
  gBulkBuf[ 1] = 0x06;
  gBulkBuf[ 2] = 0x00;
  gBulkBuf[ 3] = 0x00;
  gBulkBuf[ 4] = 0x00;
  gBulkBuf[ 5] = 0x00;
  gBulkBuf[ 6] = 0x00;
  gBulkBuf[ 7] = 0x00;

  gBulkRwLength = 8;
  DataInTransfer();
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Read Capacity Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_ReadCapacity(void)
{
  if (!DataInFormat()) return;

  /* Last Logical Block */
  gBulkBuf[ 0] = ((MSC_BlockCount - 1) >> 24) & 0xFF;
  gBulkBuf[ 1] = ((MSC_BlockCount - 1) >> 16) & 0xFF;
  gBulkBuf[ 2] = ((MSC_BlockCount - 1) >>  8) & 0xFF;
  gBulkBuf[ 3] = ((MSC_BlockCount - 1) >>  0) & 0xFF;

  /* Block gRwLength */
  gBulkBuf[ 4] = (MSC_BlockSize >> 24) & 0xFF;
  gBulkBuf[ 5] = (MSC_BlockSize >> 16) & 0xFF;
  gBulkBuf[ 6] = (MSC_BlockSize >>  8) & 0xFF;
  gBulkBuf[ 7] = (MSC_BlockSize >>  0) & 0xFF;

  gBulkRwLength = 8;
  DataInTransfer();
}

//-----------------------------------------------------------------------------
/** @brief MSC SCSI Read Format Capacity Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_ReadFormatCapacity(void)
{
  if (!DataInFormat()) return;

  gBulkBuf[ 0] = 0x00;
  gBulkBuf[ 1] = 0x00;
  gBulkBuf[ 2] = 0x00;
  gBulkBuf[ 3] = 0x08;          /* Capacity List gRwLength */

  /* Block Count */
  gBulkBuf[ 4] = (MSC_BlockCount >> 24) & 0xFF;
  gBulkBuf[ 5] = (MSC_BlockCount >> 16) & 0xFF;
  gBulkBuf[ 6] = (MSC_BlockCount >>  8) & 0xFF;
  gBulkBuf[ 7] = (MSC_BlockCount >>  0) & 0xFF;

  /* Block gRwLength */
  gBulkBuf[ 8] = 0x02;          /* Descriptor Code: Formatted Media */
  gBulkBuf[ 9] = (MSC_BlockSize >> 16) & 0xFF;
  gBulkBuf[10] = (MSC_BlockSize >>  8) & 0xFF;
  gBulkBuf[11] = (MSC_BlockSize >>  0) & 0xFF;

  gBulkRwLength = 12;
  DataInTransfer();
}

//-----------------------------------------------------------------------------
/** @brief MSC Get Command Block Wrapper Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_GetCBW(void)
{
  U32 n;

  for (n = 0; n < gBulkRwLength; n++)
  {
    *((U8 *)&gCBW + n) = gBulkBuf[n];
  }
  if ((gBulkRwLength == sizeof(gCBW)) && (gCBW.dSignature == MSC_CBW_Signature))
  {
    /* Valid CBW */
    gCSW.dTag = gCBW.dTag;
    gCSW.dDataResidue = gCBW.dDataLength;
    if ((gCBW.bLUN != 0) || (gCBW.bCBLength < 1) || gCBW.bCBLength > 16)
    {
      gCSW.bStatus = CSW_CMD_FAILED;
      MSC_SetCSW();
    }
    else
    {
      switch (gCBW.CB[0])
      {
        case SCSI_TEST_UNIT_READY:
          MSC_TestUnitReady();
          break;
        case SCSI_REQUEST_SENSE:
          MSC_RequestSense();
          break;
        case SCSI_INQUIRY:
          MSC_Inquiry();
          break;
        case SCSI_MODE_SENSE6:
          MSC_ModeSense6();
          break;
        case SCSI_MODE_SENSE10:
          MSC_ModeSense10();
          break;
        case SCSI_READ_FORMAT_CAPACITIES:
          MSC_ReadFormatCapacity();
          break;
        case SCSI_READ_CAPACITY:
          MSC_ReadCapacity();
          break;
        case SCSI_READ10:
          if (MSC_RWSetup())
          {
            if ((gCBW.bmFlags & 0x80) != 0)
            {
              /* Turn On Read LED */
              //GPIOB->ODR |= LED_RD;
              gBulkStage = MSC_BS_DATA_IN;
              MSC_MemoryRead();
            }
            else
            {
              USB_EpSetStall(USB_MSC_EP_BULK_OUT);
              gCSW.bStatus = CSW_PHASE_ERROR;
              MSC_SetCSW();
            }
          }
          break;
        case SCSI_WRITE10:
          if (MSC_RWSetup())
          {
            if ((gCBW.bmFlags & 0x80) == 0)
            {
              /* Turn On Write LED */
              //GPIOB->ODR |= LED_WR;
              gBulkStage = MSC_BS_DATA_OUT;
            }
            else
            {
              USB_EpSetStall(USB_MSC_EP_BULK_IN);
              gCSW.bStatus = CSW_PHASE_ERROR;
              MSC_SetCSW();
            }
          }
          break;
        case SCSI_VERIFY10:
          if (MSC_RWSetup())
          {
            if ((gCBW.bmFlags & 0x80) == 0)
            {
              gBulkStage = MSC_BS_DATA_OUT;
              gMemOK = TRUE;
            }
            else
            {
              USB_EpSetStall(USB_MSC_EP_BULK_IN);
              gCSW.bStatus = CSW_PHASE_ERROR;
              MSC_SetCSW();
            }
          }
          break;
        case SCSI_FORMAT_UNIT:
        case SCSI_START_STOP_UNIT:
        case SCSI_MEDIA_REMOVAL:
        case SCSI_MODE_SELECT6:
        case SCSI_MODE_SELECT10:
        default:
          gCSW.bStatus = CSW_CMD_FAILED;
          MSC_SetCSW();
          break;
      }
    }
  }
  else
  {
    /* Invalid CBW */
    USB_EpSetStall(USB_MSC_EP_BULK_IN);
    USB_EpSetStall(USB_MSC_EP_BULK_OUT);
    gBulkStage = MSC_BS_ERROR;
  }
}

//-----------------------------------------------------------------------------
/** @brief MSC Bulk In Callback
 *  @param None (global variables)
 *  @return None
 */
void MSC_BulkIn(U32 aEvent)
{
  switch (gBulkStage)
  {
    case MSC_BS_DATA_IN:
      switch (gCBW.CB[0])
      {
        case SCSI_READ10:
          MSC_MemoryRead();
          break;
      }
      break;
    case MSC_BS_DATA_IN_LAST:
      MSC_SetCSW();
      break;
    case MSC_BS_DATA_IN_LAST_STALL:
      USB_EpSetStall(USB_MSC_EP_BULK_IN);
      MSC_SetCSW();
      break;
    case MSC_BS_CSW:
      gBulkStage = MSC_BS_CBW;
      break;
  }
}

//-----------------------------------------------------------------------------
/** @brief MSC Bulk Out Callback
 *  @param aEvent - Event (global variables)
 *  @return None
 */
void MSC_BulkOut(U32 aEvent)
{
  gBulkRwLength = USB_EpRead(USB_MSC_EP_BULK_OUT, gBulkBuf);
  switch (gBulkStage)
  {
    case MSC_BS_CBW:
      MSC_GetCBW();
      break;
    case MSC_BS_DATA_OUT:
      switch (gCBW.CB[0])
      {
        case SCSI_WRITE10:
          MSC_MemoryWrite();
          break;
        case SCSI_VERIFY10:
          MSC_MemoryVerify();
          break;
      }
      break;
    default:
      USB_EpSetStall(USB_MSC_EP_BULK_OUT);
      gCSW.bStatus = CSW_PHASE_ERROR;
      MSC_SetCSW();
      break;
  }
}

//-----------------------------------------------------------------------------
/** @brief Initializes MSC Memory Image
 *  @param aEvent - Event (global variables)
 *  @return None
 */
void MSC_Init(void)
{
  U32 n;
  /* Copy Initial Disk Image from Flash to RAM */
  for (n = 0; n < MSC_ImageSize; n++)
  {
    gMemory[n] = FlashDiskImage[n];
  }
}
